---
layout: post
title: logstashé€²éšå¯¦æˆ°
author: Rick Chen
tags: Linux
date: 2022-07-14
---

## å‰è¨€
* å‰ä¸€ç¯‡æˆ‘å€‘ä»‹ç´¹äº†logstashå¸¸ç”¨çš„ä¸€äº›pattern
* ä½†å°æ–¼logstashçš„ä¸€äº›æ‡‰ç”¨ä»¥åŠgrokçš„ä¸€äº›èªæ³•ä¸æ˜¯é‚£éº¼ç†Ÿæ‚‰
* æœ¬ç¯‡ç­†è¨˜å°‡é‡å°å­¸åˆ°ã€ä½¿ç”¨åˆ°çš„åšä¸€å€‹æ”¶æ–‚

## logè§£æå¯¦æˆ°
```
[2021-02-26T16:58:29.716] [INFO] indexbackup - Backup /opt/auditbeat-self_monitor-2021.02.25.log successfully
[2021-02-26T16:58:30.052] [INFO] indexbackup - Compress /opt/auditbeat-self_monitor-2021.02.25.log successfully
[2021-02-26T17:01:49.332] [INFO] indexbackup - Backup /opt/fortinet-2021.02.25.log successfully
[2021-02-26T17:01:49.345] [INFO] indexbackup - Compress /opt/fortinet-2021.02.25.log successfully
[2021-02-26T17:01:51.095] [ERROR] indexbackup - Backup /opt/readonlyrest_audit-2021-02-25.log:connect ECONNREFUSED 192.168.0.131:1859
[2021-02-26T17:01:51.110] [ERROR] indexbackup - Compression: gzip: /opt/readonlyrest_audit-2021-02-25.log: No such file or directory

[2021-02-26T17:01:51.127] [ERROR] indexbackup - Backup /opt/metricbeat-self_monitor-2021.02.25.log:connect ECONNREFUSED 192.168.0.131:1859
[2021-02-26T17:01:51.135] [ERROR] indexbackup - Compression: gzip: /opt/metricbeat-self_monitor-2021.02.25.log: No such file or directory

[2021-02-26T17:01:51.149] [ERROR] indexbackup - Backup /opt/auditbeat-self_monitor-2021.02.25.log:connect ECONNREFUSED 192.168.0.131:1859
[2021-02-26T17:01:51.160] [ERROR] indexbackup - Compression: gzip: /opt/auditbeat-self_monitor-2021.02.25.log: No such file or directory

[2021-02-26T17:01:51.175] [ERROR] indexbackup - Backup /opt/clm-history-2021.02.25.log:connect ECONNREFUSED 192.168.0.131:1859
[2021-02-26T17:01:51.183] [ERROR] indexbackup - Compression: gzip: /opt/clm-history-2021.02.25.log: No such file or directory

[2021-02-26T17:01:51.195] [ERROR] indexbackup - Backup /opt/clm-self_monitor-2021.02.25.log:connect ECONNREFUSED 192.168.0.131:1859
[2021-02-26T17:01:51.205] [ERROR] indexbackup - Compression: gzip: /opt/clm-self_monitor-2021.02.25.log: No such file or directory

[2021-03-04T17:28:56.878] [ERROR] indexbackup - Backup /opt/kevin/indexBackup/auditbeat-self_monitor-2021.03.04:connect ECONNREFUSED
```
>å‡è¨­ä»Šå¤©æœ‰ä¸€å€‹logé•·é€™æ¨£è©²æ€éº¼è§£?

### æˆ‘çš„è§£æ³•
* é¦–å…ˆé€™å€‹logå¯ä»¥è¢«åˆ‡æˆå¹¾å€‹éƒ¨åˆ†: Time, Status, action, path, result
* indexbackupå‰‡å› ç‚ºéƒ½ç›¸åŒæ‰€ä»¥ä¸ç‰¹åˆ¥åˆ—é …ï¼Œæ²’æ„ç¾©ã€‚

```
input{
        file{
                path => "/root/indexbackup.log"
                start_position => "beginning"
                sincedb_path => "/dev/null"
        }
}
filter{
if [message] == ""{
        drop{}
}
        grok{
        match => {"message"=> "\[%{TIMESTAMP_ISO8601:time}\] \[%{DATA:status}\] %{DATA} \- %{DATA:action} %{PATH:route} %{GREEDYDATA:result}"}

}

}

output{
        stdout{}
}
```


## å¸¸è¦‹çš„ifä½¿ç”¨
1. if "xxx" in [message]{xxx}
2. if [message] == "xxx"{xxx}
3. if "xxx" in [message] and "xxx" in [xxx]{xxx}
4. if "xxx" in [message] or "xxx" in [xxx]{xxx}

## File
* é©ç”¨å ´æ™¯: å°‡æª”æ¡ˆé¤µçµ¦logstash

```
file{
                path => "" #absolute path
                type => "" #for free
                start_position => "beginning" #å¾é ­é‚„å¾å°¾
                sincedb_path => "" # è‹¥è¨­å®š/dev/nullå‰‡æ¯æ¬¡éƒ½å¾é ­
        }
```

## Multiline
* é©ç”¨æƒ…å¢ƒ: è®€å–å¤šè¡Œè³‡æ–™

```
# æ”¾åœ¨fileè£¡
codec => multiline {
          pattern => "æ­£è¦è¡¨é”å¼æˆ–grokèªæ³•"
          negate => "true" or "false"
          what => "previous" or "next"
        }
```

## Date
* é©ç”¨æƒ…å¢ƒ:å°‡logstashçš„æ™‚é–“è½‰ç‚ºlogæª”å…§çš„æ™‚é–“

```
date{
        target => "" # æŒ‡å®šçš„åç¨±ï¼Œæ²’æŒ‡å®šå°±æ˜¯@datestamp
        locale => "en"
        match => ["", "MMM dd yyyy HH:mm:ss","ISO8601" ] #æŠŠå“ªå€‹å±¬æ€§ä¸Ÿåˆ°dateè£¡é¢åšè½‰æ›
        remove_field => [""] #ç§»é™¤é …ç›®
}
```

## Elasticsearch
* é©ç”¨æƒ…å¢ƒ: å°‡è³‡æ–™å‚³é€²ESè®“æ•´å€‹ELKæ´»çµ¡

```
 elasticsearch{

                hosts => [""] # host domain name or ip
                index => "" # index name
                user => ""  # æ²’æœ‰ä½¿ç”¨è€…è·Ÿå¯†ç¢¼å°±ä¸éœ€è¦
                password => "" # æ²’æœ‰ä½¿ç”¨è€…è·Ÿå¯†ç¢¼å°±ä¸éœ€è¦
                ilm_enabled => flase # æœ‰æ¬Šé™å•é¡Œ(401)çš„è©±å°±è¨­å®šä¸€ä¸‹
        }
```

## Aggregate
* é©ç”¨æƒ…å¢ƒ: æœ‰ä¸€çµ„unique id æƒ³é€²è¡Œå·®å€¼è¨ˆç®—æ™‚ä½¿ç”¨
* ä¾‹å¦‚æœ‰ä¸€ä»½log å¦‚ä»¥ä¸‹ç‹€æ³
```
2021-02-24 00:02:19,054 - [[[37minfo[0m]] - from accessLogger in application-akka.actor.default-dispatcher-1333571 
[7482e260-9b45-4a9b-9c74-e7ed47d598af START][192.168.28.53][POST][/api/user/verifyEcToken] AHC/2.0

2021-02-24 00:02:19,054 - [[[36mdebug[0m]] - from application in application-akka.actor.default-dispatcher-1335575 
[dca02456-0f09-4706-a627-948a4a07208c]Send Request to UUPay http://epap:8080/uupay-api-appsrv/member/verify/verifyEcToken [AUTH eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ7XCJ0eXBlXCI6XCJFQ1RcIixcInVzZXJcIjpcIkIyMzg1RERBQ0M0NDRFQkM1RTYzMEVFRDIzNkQ0MURCNDYxNkIzRUQxQkZDQjc5RDkxNjRFNEJEM0ExMjAxQzlcIixcImlzc1wiOlwiQXByIDUsIDIwMjAsIDI6MjU6MDIgUE1cIixcInJlZlwiOlwiNTExYzNjNzQtYjc3Ny00ZjFkLTg3NjgtYmJiMzJhMDE1ZjFmXCIsXCJkZXZpY2VJZFwiOlwiNmQyMTU3NzgtZWRhZC00MTk0LWFiM2YtNjJiOTE3MWVhOGZlXCJ9In0.FbSLeCAk0MBtD_jyCIqBGZqpdChYEqR-S8aNRxAD5zs] {"clientHostIp":"112.78.74.244","requestDateTime":"20210224000217","deviceId":"6d215778-edad-4194-ab3f-62b9171ea8fe","locale":"zh_TW","requestUuid":"dca02456-0f09-4706-a627-948a4a07208c","encryptMemberId":"B2385DDACC444EBC5E630EED236D41DB4616B3ED1BFCB79D9164E4BD3A1201C9","token":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ7XCJ0eXBlXCI6XCJFQ1RcIixcInVzZXJcIjpcIkIyMzg1RERBQ0M0NDRFQkM1RTYzMEVFRDIzNkQ0MURCNDYxNkIzRUQxQkZDQjc5RDkxNjRFNEJEM0ExMjAxQzlcIixcImlzc1wiOlwiQXByIDUsIDIwMjAsIDI6MjU6MDIgUE1cIixcInJlZlwiOlwiNTExYzNjNzQtYjc3Ny00ZjFkLTg3NjgtYmJiMzJhMDE1ZjFmXCIsXCJkZXZpY2VJZFwiOlwiNmQyMTU3NzgtZWRhZC00MTk0LWFiM2YtNjJiOTE3MWVhOGZlXCJ9In0.FbSLeCAk0MBtD_jyCIqBGZqpdChYEqR-S8aNRxAD5zs"}

2021-02-24 00:02:19,057 - [[[36mdebug[0m]] - from application in ForkJoinPool.commonPool-worker-3 
[dca02456-0f09-4706-a627-948a4a07208c][3 ms]Received response from UUPay http://epap:8080/uupay-api-appsrv/member/verify/verifyEcToken 200 application/json;charset=UTF-8 {"returnCode":"00000","returnMsg":"æˆåŠŸ","data":null}

2021-02-24 00:02:19,057 - [[[37minfo[0m]] - from accessLogger in ForkJoinPool.commonPool-worker-3 
[7482e260-9b45-4a9b-9c74-e7ed47d598af END][200][3ms] /api/user/verifyEcToken
```
* æˆ‘å€‘æƒ³è¨ˆç®—ä»¥ä¸Šlogå¾startåˆ°stopçš„æ™‚é–“
* ä½œæ³•å¦‚ä¸‹: 
```
if [status] ==  "START" {
       aggregate{
               task_id => "%{key}"
               code => "map['start_to_end'] = Time.parse((event.get('time'))).to_f"
               map_action => "create"
       }
}
if [status] == "END" {
       aggregate{
               task_id => "%{key}"
               code => "event.set('start_to_end_period',Time.parse((event.get('time'))).to_f - map['start_to_end'])"
               map_action => "update"
               end_of_task => true
               timeout => 120
       }
}
```
* èªªæ˜:
1. aggregateä¸­çš„task_idä»£è¡¨ä½ æƒ³è™•ç†çš„ç‰©ä»¶
2. codeè£¡é¢æ˜¯rubyçš„èªæ³•,ç”¨mapçš„æ–¹å¼ä¿å­˜ä¸€å€‹å«start_to_endçš„è®Šæ•¸,é€éç”¨event.getæŠ“å€¼, æœ€å¾Œå†ç”¨Time.parseè½‰æˆrubyçœ‹å¾—æ‡‚çš„æ™‚é–“å†è½‰æˆæµ®é»æ•¸
3. map_actionå¯ä»¥å‘Šè¨´aggregateè¦create or update
4. event.setçš„ç¬¬ä¸€å€‹å€¼æ˜¯ä½ è¦å‰µé€ çš„è®Šæ•¸å,ç„¶å¾Œå¾Œé¢æ˜¯ä»–çš„å…§å®¹,æœ‰é»é¡ä¼¼ var start_to_end_period = Time.parse((event.get('time'))).to_f - map['start_to_end'])
5. end_of_taskå‘ŠçŸ¥æ˜¯å¦çµæŸ
6. timeout å®£å‘Štimeoutçš„æ™‚é–“
